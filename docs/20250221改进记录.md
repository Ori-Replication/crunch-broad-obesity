收集并阅读相关文档与实验总结，梳理现状并提出改进建议。


[21 tools called]


已阅读赛题、数据说明和 EDA 的实验总结，下面是当前结论和可尝试的改进方向。

---

# 进一步提效思路

## 一、当前状态概览

| 指标 | 最佳方法 | 数值 | 说明 |
|------|----------|------|------|
| **CV Pearson（基因表达）** | PM+FlowImp_pc5_a0.11 | ~0.230 | 相对 PM 约 +4% |
| **线上泛化** | FlowXA_pc10_xpc20 | 0.1767 | PM 线上过拟合，Flow 更稳 |
| **CV L1（细胞比例）** | Gene2vec KNN (K=10~20) | ~0.092 | 优于 Average ~0.098 |
| **外部数据迁移** | PCA_HEK_pc5_α100 | ~+2% | xatlas 与竞赛数据相似度≈0，迁移有限 |

主要瓶颈：训练扰动少（约 122 个）、外部数据细胞类型差异大、部分方法在 CV 上偏高但线上易过拟合。

---

## 二、推荐优先尝试的方向

### 1. 生物学先验与调控网络（尚未充分尝试）

- **STRING k-NN 插值（fallback）**：对训练集中没有 loadings 的基因，用 STRING 找训练基因邻居，用邻居 loadings 加权平均，减少“纯 PM”比例。  
- **TRRUST / ChIP-Atlas**：约 150 个训练基因为 TF，可利用 TF→靶基因调控关系构造特征。  
- **KEGG / Reactome 通路**：同通路基因可能有相似扰动效应，用通路 membership 或 one-hot 做条件或插值依据。  
- **TF 家族 / DNA 结合域**：作为离散特征，embedding 后拼入 condition。

这些在 `docs/改进思路_外部资料与Embedding.md` 中已有思路，但尚未在实验中系统验证。

---

### 2. 多方法集成与 Stacking

目前单方法最优约 0.23，方差较大（std≈0.24–0.31），集成有可能提稳、提分：

- **Stacking**：以 PM、FlowXA、PCA_HEK、PM+CoExpr 的 CV 预测为 meta 特征，用小模型（Ridge/轻量 MLP）学习组合权重。  
- **按扰动类型集成**：对 CV 表现差异大的扰动（如 RNASEH2C、CEBPA 等）单独分析，不同扰动用不同方法或权重。  
- **基于不确定度加权**：用集成方差或预测分散度判断不确定性，对高不确定预测增加 PM 比例。

---

### 3. PRISM 脂肪细胞数据 GSE217812 深入挖掘

- **现状**：扰动重叠仅 CEBPB（1/122），单次相似度很低（~0.03），之前结论偏悲观。  
- **仍有价值**：  
  - 脂肪细胞与脂肪前体，比 xatlas 的 HEK293T/HCT116 更接近任务。  
  - 可尝试基于 PC 或通路而非“逐扰动相似度”的迁移。  
- **建议**：  
  - 用 PRISM 学习“脂肪细胞扰动”的通用 PC 空间，再映射到竞赛空间。  
  - 或把 PRISM 作为正则化/对比学习的辅助数据，而不是主迁移源。

**已实现**（2025-02-23）：`eda/GSE217812/` 预处理脚本 + `prepare_resources.py` 集成。将 D8 池化 delta 作为额外行参与 PCA，增强脂肪细胞先验。详见 `eda/GSE217812/README.md`。

---

### 4. 基因子集 / DEG 与分模块建模

DEG 实验显示，**de_freq≥10** 基因上 Pearson 可达 0.2327，明显优于全基因。

- **分层预测**：  
  - 高 DEG 频率基因：用 PM+CoExpr 或 PCA_HEK / Flow 等更强模型；  
  - 低 DEG 频率基因：用 PM 或简单模型，避免过拟合。  
- **已部分验证**：DEG_freq≥5 的 CoExpr 策略已有小幅提升，可继续调 DEG 阈值和对应模型。

---

### 5. Flow 条件与正则化微调

- **轻量 MLP 融合条件**：  
  - 当前 `c = [loadings | embedding]` 简单拼接易过拟合。  
  - 用小 MLP 学习 `[loadings, gene2vec_PCA, pathway] → condition` 或 `→ delta`，参数控制在几百到几千。  
- **CosineSim 约束**：  
  - Flow 实验显示 CosineSim≈0.99 时几乎等同 PM、易过拟合。  
  - 在训练/验证中显式约束 CosineSim 在约 0.90–0.95，作为正则，避免完全塌向 PM。  
- **更细的 α 网格**：  
  - PM+Flow 在 α=0.08–0.12 附近有潜力，可做更密的网格（如 0.02 步长）搜索。

---

### 6. 细胞比例 L1 的进一步优化

- **聚类 + 最近邻**：  
  - 对训练基因按比例做 K=5 聚类，测试基因用 Gene2vec/ESM2 找最近训练基因，取该基因所在簇的质心，保证约束、减少噪声。  
- **约束与后处理**：  
  - 强制 pre + adipo + other = 1；  
  - lipo = min(lipo, adipo)，避免 ratio 爆炸；  
  - adipo < 0.05 时置 lipo=0、ratio=0。  
- **集成**：  
  - Gene2vec KNN 与 Average 的加权组合，例如按最近邻距离调节 α（近则偏 KNN，远则偏 Average）。

---

### 7. 注意力与检索增强

- **Attention over training perturbations**：  
  - 对每个测试基因，学习对 122 个训练扰动权重的注意力，类似 “relevant perturbations retrieval”。  
- **Retrieval-augmented prediction**：  
  - 基于 Gene2vec/ESM2/STRING 检索最相关训练基因，用其 delta 的加权平均做预测，可替代或补充 PM。

---

### 8. 其他数据与表示

- **基因别名映射**：  
  - Gene2vec 缺失约 83 个 predict 基因，可用 mygene.info / HGNC 做 symbol 别名映射，提高 embedding 覆盖。  
- **GO 语义相似度**：  
  - 基于 GO 的基因功能相似度，用于 k-NN 插值或条件构造。  
- **xatlas 的共调控结构**：  
  - 不直接用 xatlas delta 迁移，而用其基因共调控/模块结构作为先验，辅助竞赛数据的学习。

---

### 9. 评估与过拟合缓解

- **多折、多随机种子**：  
  - 5 折 CV 以外，增加 3–5 个随机种子，评估方法稳定性。  
- **CosineSim 作为验证指标**：  
  - 与 PM 过于接近（>0.98）的方法谨慎采用，倾向 CosineSim 在 0.90–0.95 的折中方案。  
- **留一扰动验证（LOOCV）**：  
  - 在 122  perturbation 上做 leave-one-perturbation-out，检验泛化到“新扰动”的能力。

---

### 10. 建模范式扩展（工作量较大）

- **GNN**：  
  - 以基因为节点，STRING/GO 为边，预测扰动效应。  
- **Meta-learning（如 MAML）**：  
  - 按扰动划分 support/query，学习“如何从少量扰动快速适应新基因”。  
- **对比学习**：  
  - 在 delta 空间拉近“相似基因的扰动效应”，推远“不相似基因”。  

这些属于更长线探索，适合在基础方向稳定后再投入。

---

## 三、实施优先级建议

| 优先级 | 方向 | 工作量 | 预期收益 | 风险 |
|--------|------|--------|----------|------|
| **1** | STRING k-NN fallback + 生物学先验 | 低–中 | 中 | 低 |
| **2** | 多方法 Stacking / 集成 | 中 | 中–高 | 低 |
| **3** | DEG 分层 / 基因子集策略 | 低 | 中 | 低 |
| **4** | PRISM GSE217812 深度利用 | 中 | 中（不确定） | 中 |
| **5** | Flow 轻量 MLP 融合 + CosineSim 约束 | 中 | 中 | 中 |
| **6** | 细胞比例聚类 + 约束后处理 | 低 | 低–中 | 低 |
| **7** | Attention / Retrieval-augmented | 高 | 中–高 | 中 |
| **8** | GNN / Meta-learning | 高 | 不确定 | 高 |

---

## 四、核心结论

1. **外部迁移**：xatlas 迁移效果有限；PRISM GSE217812 值得专门再试，但重点应放在“脂肪细胞通用结构”而非逐扰动相似度。  
2. **Embedding**：Gene2vec/ESM2/scGPT 简单拼接效果一般，更值得尝试的是 **多源条件轻量融合 + 生物学先验**。  
3. **过拟合**：PM 在线上易过拟合，FlowXA 泛化更好；集成和 CosineSim 约束有助于平衡 CV 表现与线上稳定性。  
4. **L1 比例**：Gene2vec KNN 已有提升，可在此基础上增加聚类、约束和集成。

如果你希望优先落地某一块（例如 STRING fallback 或 Stacking），可以指定方向，我可以按该方向给出更具体的实现步骤和伪代码。