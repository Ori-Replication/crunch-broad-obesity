# 肥胖症机器学习竞赛：攻克代谢性疾病 —— 第一部分  
你能否设计出识别驱动肥胖和代谢疾病的基因的算法？

你将使用与 Eric and Wendy Schmidt 中心（隶属于 Broad 研究所）、Broad 糖尿病倡议（Broad Diabetes Initiative）、马萨诸塞州总医院（Massachusetts General Hospital）以及贝斯以色列女执事医疗中心（Beth Israel Deaconess Medical Center）合作收集的尖端生物数据。你的算法可能直接推动肥胖相关生物学发现！

---

## 快速概览（TL;DR）

**目标**：识别能够“欺骗”人类细胞燃烧脂肪而非储存脂肪的基因“开关”。

**数据科学任务**：你将获得使用 CRISPR/Cas9 技术敲除（关闭）特定基因后的人类细胞单细胞 RNA 测序（scRNA-seq）数据。

**挑战**：构建一个模型，预测在敲除一个从未见过的新基因时，细胞的行为和发育会发生怎样的变化。

---

## 引言

### 生物学背景：储存能量 vs. 燃烧能量

人体脂肪并非千篇一律。我们身体主要依靠两种类型的脂肪细胞（adipocytes）来管理能量：

- **白色脂肪**：即“储存型”细胞。它们将食物中的多余能量储存起来。一旦储存过多，就会导致肥胖和 2 型糖尿病等代谢疾病。
- **棕色脂肪**：即“炉子型”细胞。它们不储存能量，而是通过燃烧糖和脂肪产生热量（产热作用，thermogenesis）。

目前大多数减肥药的作用机制是降低食欲。然而，科学家们正在探索另一种方法：**如果我们能让身体产生更多棕色脂肪，或者促使白色脂肪开始燃烧能量会怎样？**

### 实验：拨动基因开关

为了找到控制这些过程的生物“开关”，研究人员正在进行大规模实验。他们从人体中获取脂肪前体细胞，并使用 CRISPR/Cas9 技术逐个关闭特定基因，然后观察：

- 该细胞是否仍能分化为脂肪细胞？
- 它表现得像白色脂肪细胞（储存）还是棕色脂肪细胞（燃烧）？
- 细胞内部的分子机器（基因表达）发生了哪些变化？

### 为何不能对人类基因组中的每个基因都进行物理测试？

人类基因组包含约 20,000 个基因！逐一测试既耗时又昂贵。我们需要**机器学习来填补数据空白**。通过在已有实验数据上训练模型，你的算法将预测尚未测试基因被敲除后的生物学结果。

### 这项研究为何重要？

全球有超过 8.9 亿人受肥胖影响，而肥胖是心血管疾病和癌症的主要诱因。尽管已有减肥药物，但它们并非对所有人都有效，且常伴有副作用。

为了开发更好的疗法，我们必须理解代谢的基本“代码”：

- 哪些基因决定了脂肪细胞的发育方式？
- 哪些基因能帮助白色脂肪细胞转化为棕色/产热型脂肪细胞？
- 哪些基因调控细胞储存或燃烧脂肪的方式？

如果你的模型能够成功模拟基因扰动对脂肪细胞的影响，研究人员将能**纯计算地筛选数千个潜在药物靶点**，从而极大加速恢复代谢平衡、对抗疾病的药物发现进程。

---

## 竞赛挑战

在本次竞赛中，你将使用**单细胞 RNA 测序（scRNA-seq）数据**，该数据反映了每个单细胞中各基因的表达水平。科学家已使用 CRISPR/Cas9 技术在脂肪前体细胞中“敲除”（删除）了不同基因，并测量了细胞的变化。

你的任务是构建一个模型，预测当科学家敲除测试集中**新出现的基因**时会发生什么。

你必须预测以下**两个具体结果**：

### 1. “内部状态”（基因表达谱）

你需要预测目标基因被敲除后，单个细胞的基因表达谱。这是一个高维向量，代表细胞内数千个基因的活性水平。

### 2. “细胞身份”（细胞类型分化）

正常情况下，这些前体细胞会分化为特定类型的脂肪细胞。你需要估计敲除后产生的**四种不同细胞状态的比例**：

- **Pre-adipocyte（前脂肪细胞）**：尚未分化的早期细胞。
- **Adipocyte（脂肪细胞）**：成熟的白色脂肪细胞。
- **Lipogenic（脂质生成细胞）**：特化的脂肪生成细胞。
- **Other（其他）**：走向其他发育路径的细胞。

有关完整规范，请参阅详细说明文档。

---

## 快速入门课程

与去年类似，Eric and Wendy Schmidt 中心团队准备了一套**80 分钟的系列讲座**，涵盖完成本挑战所需的生物学基础知识。

---

## 评估阶段

在 **Crunch 1 阶段**，你将有机会在验证数据集上评估模型的预测性能。

**每周一 UTC 时间 18:00 将进行一次验证检查点（checkpoint）**：

- **检查点 1**：12 月 22 日
- **检查点 n**：每周一
- **最后一个检查点**：2 月 23 日
- **最终提交截止**：2 月 28 日

你可以在平台上多次提交和运行代码。  
在每个检查点，所有你提交的（尚未评分的）预测将被统一评分。

---

## 概述

在 Crunch 1 中，我们将探索模型在预测**训练数据中未测量的单基因扰动**所引发的单细胞转录组响应方面的表现。

---

## 数据集

数据集包含针对 **157 个基因**的扰动实验，其中 **150 个为转录因子（TFs）**。对于每种扰动，我们在脂肪细胞分化的第 14 天测量了单细胞基因表达（RNA-seq）谱，并标注了基因扰动身份、质量控制（QC）指标和细胞元数据。

- **训练集**包含这些扰动的一个子集。
- **验证集和测试集**则包含一组完全不同的单基因扰动（保留未公开）。

### 数据格式

- 数据以 **AnnData 格式（.h5ad）** 提供，文件名为 `obesity_challenge_1.h5ad`。
- **标准化后的基因表达值**存储在 `adata.X` 中。原始计数经过标准化（每细胞目标总和为 100,000），再进行 `log₂(1 + x)` 转换（标准单细胞 RNA-seq 标准化流程；参见快速入门课程第 2 讲）。
- **标准化前的原始计数**存储在 `adata.layers['counts']` 中，用于复现或替代预处理。
- **扰动靶基因信息**位于 `adata.obs['gene']`，值为 `"NC"`（对照组，无效应）或靶基因名称（若该细胞被扰动）。
- **细胞状态/程序富集信息**位于 `.obs` 中，包含四列：`pre_adipo`、`adipo`、`lipo` 和 `other`，表示该细胞是否富集了前脂肪细胞、脂肪细胞或脂质生成程序。`other` 定义为未富集前脂肪或脂肪程序的细胞。这些分配基于专家整理的标志性基因（signature genes），完整列表见 `signature_genes.csv`。
- 每种扰动的**细胞状态比例**在单独文件 `program_proportion.csv` 中提供。

### 预处理流程

- 应用标准单细胞质量控制（QC），剔除低质量细胞和双细胞（doublets），依据包括测序文库复杂度、基因检出率和线粒体基因含量。
- 仅保留具有**单一、可信向导 RNA（guide）分配**的细胞。
- 剔除细胞数少于 10 的向导。
- 剔除在少于 10 个细胞中检出的基因，但随后重新加入 `signature_genes.csv` 中的标志性基因。

### `.obs` 列定义

| 列名 | 说明 |
|------|------|
| `orig.ident` | 原始样本 ID |
| `nCount_RNA` | 每细胞检测到的 UMI 数量 |
| `nFeature_RNA` | 每细胞检测到的基因数量 |
| `nCount_guide` | 每细胞检测到的 sgRNA UMI 数量 |
| `nFeature_guide` | 每细胞检测到的 sgRNA 数量 |
| `percent.mt` | 每细胞中映射到线粒体转录本的 UMI 比例 |
| `SampleID` | 样本 ID |
| `Day` | 样本采集日期 |
| `num_features` | 每细胞的向导数量（低 MOI 数据经 QC 后仅保留含 1 个向导的细胞） |
| `feature_call` | 每细胞的向导分配 |
| `num_umis` | 每细胞的向导 UMI 数量 |
| `gene` | 扰动靶基因（或扰动身份） |
| `positive_control` | 该扰动是否为阳性对照 |

---

## 预期输出

参赛者需提交以下**三个文件**：

### 文件 1：`prediction.h5ad`

- 一个 AnnData 文件，包含对 `predict_perturbations.txt` 中列出的 **2,863 个基因扰动**的预测基因表达谱。
- 预测结果应存储在 `adata.X` 矩阵中，对应的扰动身份记录在 `adata.obs['gene']`。
- 预测所包含的基因（列）由推理时提供的 `genes_to_predict` 明确定义，`adata.X` 的列顺序必须与此列表一致。
  - 注意：`genes_to_predict` 列表在验证阶段（N=10,237）和测试阶段可能不同，模型必须能生成任意给定基因集的预测。
  - 最大可能基因数为 21,592（即数据集中总基因数）。
- 对每个基因扰动，需预测 **100 个细胞**的表达谱，以量化扰动预测的分布。
- 最终预测文件维度应为：**[286,300 × N]**（细胞数 × genes_to_predict）。

### 文件 2：`predict_program_proportion.csv`

- 一个 CSV 文件，报告 `predict_perturbations.txt` 中每个基因扰动的**预测细胞程序富集比例**。
- 每行对应一个扰动，包含以下列：
  - `gene`：扰动名称
  - `pre_adipo`, `adipo`, `lipo`, `other`：对应细胞状态的预测比例
  - `lipo_adipo`：`lipo / adipo` 的比值（表示富集脂质生成程序的脂肪细胞比例）
- 该文件应有 **2,863 行、6 列**。示例见 `data/` 目录。

### 文件 3：`Method description.md`

请撰写一份简短文档，概述用于生成预测和细胞程序比例估计的方法。

内容应包含足够的计算模型细节和推导细胞比例的流程说明。

文档需按以下三部分组织（使用 Markdown 标题）：

#### # Method Description（方法描述）

（5–10 句）解释你的方法如何工作。

#### # Rationale（设计原理）

（5–10 句）描述你选择该模型的理由。

#### # Data and Resources Used（所用数据与资源）

（5–10 句）列出使用的数据集及其他资源。

> **注意**：
> - 竞赛结束后将由人工审核内容，不合格者可能被取消资格。
> - 提交时必须包含此文件。
> - 如需修改，必须重新提交新版本。
> - 文件名必须为 `Method Description.md`（大小写不敏感）。
> - 仅非空、非注释行计入内容。

**格式示例**：

```markdown
# Method Description

<!-- Explain how your method works. (5-10 sentences) -->
Lorem ipsum dolor sit amet, consectetur adipiscing elit.
Aliquam eget augue quis metus viverra vehicula sit amet lacinia odio.

# Rationale

<!-- Describe the reasoning behind your model. (5-10 sentences) -->
Praesent dignissim ipsum vel leo eleifend, eget pulvinar mauris ornare.
Duis efficitur lectus posuere iaculis dictum.

# Data and Resources Used

<!-- Specify the datasets and any other resources utilized. (5-10 sentences) -->
Donec feugiat eros vel odio gravida venenatis.
Nam et sem sit amet nisi vestibulum semper bibendum et libero.
```

若格式明显错误，将立即收到通知。  
Notebook 用户需使用嵌入文件。

---

## 评分标准

每项指标将在**独立排行榜**上展示，排名和获奖机会各不相同。

指标分为两大类：

### 1. 全转录组指标（Transcriptome-wide metrics）

针对每种扰动，使用预测矩阵中的一组基因子集进行计算，包括：

- **Pearson Delta**：预测与观测扰动效应相对于扰动均值的 Pearson 相关系数差值。
- **最大均值差异（MMD）**：预测与观测单细胞表达谱分布之间的 MMD。

- **公开排行榜 / 验证阶段**（每周更新）：使用 1,000 个隐藏基因评估。
- **私有排行榜 / 测试阶段**：评分基因的数量和身份均不公开。

### 2. 程序层级指标（Program-level metric）

评估模型是否捕捉到有意义的生物学结果：

- **L1 距离**：预测与观测的四种细胞状态比例（前脂肪、脂肪、脂质生成、其他）之间的 L1 距离。

> **评估代码已开源在 GitHub**。  
> 本地评分代码将在 quickstarter 中提供。  
> 有关指标公式的详细说明，请参阅《完整规范》。

---

## 提交要求

要构建有效提交，你的模型必须在 `infer` 函数中编码，并严格遵守 Crunch 代码提交接口。

```python
def train(
    data_directory_path: str,
    model_directory_path: str,
) -> None:
    """
    训练扰动预测模型。

    参数:
      data_directory_path: 数据所在目录。
      model_directory_path: 模型状态应保存的目录（通常命名为 `resources/`）。
    
    返回:
      None: 返回值将被忽略。
    """
```

> **建议**：由于数据集较大且云端资源有限，**推荐本地训练并提交模型权重**。

请确保 `Method description.md` 文件充分记录你的模型，以便 Eric and Wendy Schmidt 中心团队在发表成果时引用你的工作。

```python
def infer(
    data_directory_path: str,
    prediction_directory_path: str,
    prediction_h5ad_file_path: str,
    program_proportion_csv_file_path: str,
    model_directory_path: str,
    predict_perturbations: list[str],
    genes_to_predict: list[str],
):
    """
    对一组扰动运行推理。

    参数:
      data_directory_path: 训练 AnnData 文件路径。
      prediction_directory_path: 可写入预测文件的目录。
      prediction_h5ad_file_path: `prediction.h5ad` 文件的直接写入路径。
      program_proportion_csv_file_path: `predict_program_proportion.csv` 文件的直接写入路径。
      model_directory_path: 存放持久化模型文件的目录。
      predict_perturbations: 需生成预测的扰动列表。
      genes_to_predict: 需包含在 prediction.h5ad 中的基因名列表（列顺序）。

    返回:
      None: 返回值将被忽略。

    预期生成文件:
      prediction_directory_path / "prediction.h5ad": anndata.AnnData
            维度为 (n_perturbations * cells_per_perturbation, n_genes_to_predict) 的 AnnData 矩阵，
            包含预测的基因表达值。
      prediction_directory_path / "predict_program_proportion.csv": pd.DataFrame
            DataFrame（index=False），包含每种扰动的细胞类型比例估计。
    """
```

示例代码见 quickstarter。

---

## 外部资源

鼓励参赛者使用**公开可用的外部资源**，包括基因扰动数据集和预训练模型，**只要适当注明来源即可**。