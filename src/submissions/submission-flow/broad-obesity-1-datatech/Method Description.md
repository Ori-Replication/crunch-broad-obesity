# Method Description

This method employs **Flow Matching** (PM+Flow_pc5_a0.10) to predict gene perturbation effects in adipocyte precursor cells, using only the competition training data without external datasets.

## Core Approach: Flow Matching Combination

1. **Training delta computation**: For each of the 122 training perturbations, compute the mean expression delta (perturbed - control) across all cells.

2. **Dual PCA setup**:
   - PCA on (genes x train_perts): gene loadings as condition features
   - PCA on (train_perts x genes): perturbation PC scores as generation targets

3. **Flow matching**: Learn a conditional velocity field v_theta(x_t, t, c) that transports from standard Gaussian N(0,I) to perturbation PC scores, conditioned on gene loadings c. The model learns p(perturbation effect | gene identity) in the latent PCA space.

4. **Combination strategy**: `(1-alpha)*PerturbMean + alpha*FlowMatch` with alpha=0.10. Pure flow matching tends to overfit with ~122 training samples; blending with the robust PerturbMean baseline balances variance and improves generalization.

5. **Prediction**: For each of the 2863 target perturbations (gene names), use the gene's PCA loadings as condition, integrate the learned ODE from x_0~N(0,I) to obtain predicted PC scores, decode to delta space, and blend with PerturbMean. For genes not in the loadings matrix, fall back to PerturbMean.

6. **Cell generation**: Sample 100 NC (control) cells with mean-matching, then add the predicted delta to generate perturbed cell profiles.

## Rationale

Flow matching models the conditional distribution of perturbation effects given gene identity in a low-dimensional PCA space. By learning a generative model in latent space, we capture non-linear structure that linear regression may miss. The PM+Flow combination (alpha=0.10) was selected via 5-fold cross-validation as the best trade-off, achieving Pearson 0.2289 vs 0.2215 for PerturbMean (+3.4%), and 0.2263 for PCA-Ridge regression.

## Data and Resources Used

- **Competition data only**: `obesity_challenge_1.h5ad` for training delta computation, flow matching training, and NC cell sampling. No external datasets (e.g., xatlas) are used.
- **Pre-computed**: `prediction_table_fp16_compressed.h5ad` contains the predicted mean expression profile for all 2863 target perturbations, generated by `prepare_resources.py`.
- **Program proportions**: Average proportions from `program_proportion.csv`.
