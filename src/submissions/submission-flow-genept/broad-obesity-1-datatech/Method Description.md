# Method Description

This method employs **Flow Matching with xatlas** (FlowXA_pc10_xpc20) to predict gene perturbation effects in adipocyte precursor cells, using external xatlas HEK293T data as additional conditioning features.

## Core Approach: Pure Flow Matching + xatlas

1. **Training delta computation**: For each of the 122 training perturbations, compute the mean expression delta (perturbed - control) across all cells.

2. **Dual PCA setup**:
   - PCA on (genes x train_perts): gene loadings as condition features
   - PCA on (train_perts x genes): perturbation PC scores as generation targets
   - PCA on xatlas HEK293T deltas: additional condition features

3. **Condition**: Concatenate [gene_loadings | xatlas_PCA_features]
   - For genes in xatlas: use both competition PCA loadings and xatlas PCA features
   - For genes not in xatlas: use gene loadings with zero-padded xatlas features

4. **Flow matching**: Learn a conditional velocity field v_theta(x_t, t, c) that transports from standard Gaussian N(0,I) to perturbation PC scores, conditioned on [gene loadings | xatlas features]. The model learns p(perturbation effect | gene identity + external knowledge) in the latent PCA space.

5. **Pure Flow (no PerturbMean)**: Unlike previous PM+Flow methods that blend with PerturbMean, this version uses pure flow matching to avoid overfitting to the training mean. CV result: Pearson=0.1767, CosineSim=0.5442 (significantly different from PerturbMean).

6. **Prediction**: For each of the 2863 target perturbations (gene names), use the gene's condition [PCA loadings | xatlas features], integrate the learned ODE from x_0~N(0,I) to obtain predicted PC scores, decode to delta space. For genes not in the loadings matrix, fall back to training mean.

7. **Cell generation**: Sample 100 NC (control) cells with mean-matching, then add the predicted delta to generate perturbed cell profiles.

8. **Cell proportion prediction**: Use ProportionKNNPredictor with **GenePT** text embeddings (NCBI gene descriptions, text-embedding-ada-002, 1536-dim). PCA to 32 dims, K=15 KNN. GenePT has 99.5% coverage of prediction targets. Fallback: scGPT, then Gene2vec, then average proportions.

## Rationale

The key insight from previous experiments:
- **PM+Flow** achieves high CV Pearson (~0.22) but has very high cosine similarity to PerturbMean (>0.99), indicating the flow component contributes little
- This leads to **severe overfitting** on the online validation (L1=0.109, MMD=0.075)
- **Pure FlowXA** has lower CV Pearson (~0.18) but significantly different from PerturbMean (CosineSim=0.54), suggesting better generalization

This version prioritizes generalization over CV score, betting that the pure flow approach with xatlas conditioning will perform better on unseen validation sets.

## Data and Resources Used

- **Competition data**: `obesity_challenge_1.h5ad` for training delta computation
- **External data**: xatlas HEK293T perturbation data for additional conditioning features
- **Pre-computed**: `prediction_table_fp16_compressed.h5ad` contains the predicted mean expression profile for all 2863 target perturbations, generated by `prepare_resources.py`
- **GenePT**: Gene embeddings from Zenodo 10833191 (NCBI text descriptions, OpenAI ada-002), used for cell proportion KNN prediction
- **Program proportions**: Average proportions from `program_proportion.csv`; KNN predictor uses GenePT embeddings (n_pca=32, k=15)
